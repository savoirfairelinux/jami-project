FROM debian:buster

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get clean
RUN apt-get update && \
    apt-get install -y -o Acquire::Retries=10 \
        ca-certificates \
        curl \
        devscripts \
        dirmngr \
        gnupg \
        tee \
        vim

RUN curl --retry 10 -s https://dl.jami.net/public-key.gpg | \
    tee /usr/share/keyrings/jami-archive-keyring.gpg > /dev/null
RUN sh -c "echo 'deb [signed-by=/usr/share/keyrings/jami-archive-keyring.gpg] https://dl.jami.net/nightly/debian_10_qt/ jami main' > /etc/apt/sources.list.d/qt-jami.list"
RUN apt-get update

RUN apt-get clean
RUN if [ -z "${OVERRIDE_PACKAGING_DIR}" ] && \
       [ -f "/opt/ring-project-ro/${OVERRIDE_PACKAGING_DIR}/control" ]; then \
           mk-build-deps \
               --remove --install \
               --tool "apt-get -y --no-install-recommends -o Acquire::Retries=10" \
               "/opt/ring-project-ro/${OVERRIDE_PACKAGING_DIR}/control"; \
    else \
        mk-build-deps \
            --remove --install \
            --tool "apt-get -y --no-install-recommends -o Acquire::Retries=10" \
            "/opt/ring-project-ro/packaging/rules/debian/control"; \
    fi

ADD scripts/build-package-debian.sh /opt/build-package-debian.sh

CMD /opt/build-package-debian.sh
